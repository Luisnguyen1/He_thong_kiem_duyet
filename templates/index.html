<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm duy·ªát n·ªôi dung NSFW</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        hr { border: 0; height: 1px; background: #ddd; margin: 2em 0; }
        form { margin-bottom: 1em; }
        input[type="file"], input[type="url"] { padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; width: calc(100% - 130px); margin-right: 10px; }
        button { padding: 0.5em 1em; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; font-size: 1em; margin: 2px; }
        button:hover { background-color: #0056b3; }
        button.fast { background-color: #28a745; }
        button.fast:hover { background-color: #1e7e34; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .api-mode-selector { 
            background: #f8f9fa; 
            padding: 1em; 
            border-radius: 5px; 
            margin: 1em 0; 
            border: 1px solid #dee2e6;
        }
        .api-mode-selector h4 { margin-top: 0; color: #495057; }
        .mode-option { 
            display: inline-block; 
            margin-right: 15px; 
            padding: 5px 0;
        }
        .mode-option input[type="radio"] { margin-right: 5px; }
        .timer { 
            font-size: 0.9em; 
            color: #6c757d; 
            margin: 10px 0; 
            font-family: "Courier New", Courier, monospace;
        }
        .timer.running { color: #007bff; font-weight: bold; }
        .result { margin-top: 1em; padding: 1em; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; white-space: pre-wrap; word-wrap: break-word; font-family: "Courier New", Courier, monospace; }
        .result-summary { 
            background: #e9ecef; 
            padding: 1em; 
            border-radius: 5px; 
            margin-bottom: 1em; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .result-summary.nsfw { background: #f8d7da; border: 1px solid #f1aeb5; }
        .result-summary.safe { background: #d1edff; border: 1px solid #9fdbff; }
        .error { color: #d8000c; background-color: #ffbaba; border-color: #d8000c; }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #007bff; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            animation: spin 1.5s linear infinite; 
            display: none; 
            margin: 10px 0;
            display: inline-block;
        }
        .loading-container { display: none; align-items: center; margin: 10px 0; }
        .loading-container.show { display: flex; }
        .loading-text { margin-left: 10px; color: #007bff; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .performance-info {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Ki·ªÉm duy·ªát n·ªôi dung NSFW</h1>
        <p>S·ª≠ d·ª•ng opennsfw2 v√† Flask ƒë·ªÉ ph√¢n t√≠ch h√¨nh ·∫£nh v√† video v·ªõi AI.</p>
        
        <div id="formats-info" style="background: #e7f3ff; padding: 1em; border-radius: 5px; margin-bottom: 2em;">
            <h3>üìã ƒê·ªãnh d·∫°ng ƒë∆∞·ª£c h·ªó tr·ª£</h3>
            <p><strong>H√¨nh ·∫£nh:</strong> <span id="image-formats">ƒêang t·∫£i...</span></p>
            <p><strong>Video:</strong> <span id="video-formats">ƒêang t·∫£i...</span></p>
            <p><strong>K√≠ch th∆∞·ªõc t·ªëi ƒëa:</strong> <span id="max-size">ƒêang t·∫£i...</span></p>
        </div>

        <hr>

        <h2>üñºÔ∏è Ph√¢n t√≠ch H√¨nh ·∫£nh</h2>
        <form id="image-form">
            <h3>T·∫£i l√™n m·ªôt ·∫£nh</h3>
            <input type="file" name="file" id="image-file" accept="image/*" required>
            <button type="submit">Ki·ªÉm tra ·∫¢nh</button>
        </form>
        <form id="image-url-form">
            <h3>...ho·∫∑c cung c·∫•p URL ·∫£nh</h3>
            <input type="url" name="url" id="image-url" placeholder="https://example.com/image.jpg" required>
            <button type="submit">Ki·ªÉm tra URL</button>
        </form>
        
        <div class="loading-container" id="image-loading">
            <div class="loader"></div>
            <div class="loading-text">ƒêang ph√¢n t√≠ch ·∫£nh...</div>
        </div>
        <div id="image-timer" class="timer"></div>
        <div id="image-result" class="result" style="display:none;"></div>

        <hr>

        <h2>üé• Ph√¢n t√≠ch Video</h2>
        
        <div class="api-mode-selector">
            <h4>‚öôÔ∏è Ch·∫ø ƒë·ªô ph√¢n t√≠ch:</h4>
            <div class="mode-option">
                <input type="radio" id="video-mode-standard" name="video-mode" value="standard">
                <label for="video-mode-standard">üîç <strong>Chu·∫©n</strong> - Ph√¢n t√≠ch chi ti·∫øt (ch·∫≠m h∆°n, ch√≠nh x√°c cao)</label>
                <div class="performance-info">‚è±Ô∏è Ph√¢n t√≠ch t·∫•t c·∫£ frames, th·ªùi gian: 30-60 gi√¢y</div>
            </div>
            <div class="mode-option">
                <input type="radio" id="video-mode-fast" name="video-mode" value="fast" checked>
                <label for="video-mode-fast">‚ö° <strong>Nhanh</strong> - Ph√¢n t√≠ch t·ªëi ∆∞u (nhanh, ch√≠nh x√°c t·ªët)</label>
                <div class="performance-info">üöÄ Sampling frames + Early stopping, th·ªùi gian: 5-15 gi√¢y</div>
            </div>
        </div>
        
        <form id="video-form">
            <h3>T·∫£i l√™n m·ªôt video</h3>
            <input type="file" name="file" id="video-file" accept="video/*" required>
            <button type="submit" id="video-submit-btn">Ki·ªÉm tra Video</button>
        </form>
        <form id="video-url-form">
            <h3>...ho·∫∑c cung c·∫•p URL video</h3>
            <input type="url" name="url" id="video-url" placeholder="https://example.com/video.mp4" required>
            <button type="submit" id="video-url-submit-btn">Ki·ªÉm tra URL Video</button>
        </form>
        
        <div class="loading-container" id="video-loading">
            <div class="loader"></div>
            <div class="loading-text" id="video-loading-text">ƒêang ph√¢n t√≠ch video...</div>
        </div>
        <div id="video-timer" class="timer"></div>
        <div id="video-result" class="result" style="display:none;"></div>
    </div>

    <script>
        let imageStartTime, videoStartTime;
        let imageTimer, videoTimer;

        // Load supported formats on page load
        window.addEventListener('DOMContentLoaded', loadSupportedFormats);

        async function loadSupportedFormats() {
            try {
                const response = await fetch('/supported_formats');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('image-formats').textContent = data.supported_image_extensions.join(', ');
                    document.getElementById('video-formats').textContent = data.supported_video_extensions.join(', ');
                    document.getElementById('max-size').textContent = data.max_file_size_mb + ' MB';
                    
                    // Update file input accept attributes
                    const imageExtensions = data.supported_image_extensions.join(',');
                    const videoExtensions = data.supported_video_extensions.join(',');
                    document.getElementById('image-file').setAttribute('accept', imageExtensions);
                    document.getElementById('video-file').setAttribute('accept', videoExtensions);
                } else {
                    document.getElementById('image-formats').textContent = 'Kh√¥ng th·ªÉ t·∫£i';
                    document.getElementById('video-formats').textContent = 'Kh√¥ng th·ªÉ t·∫£i';
                    document.getElementById('max-size').textContent = 'Kh√¥ng th·ªÉ t·∫£i';
                }
            } catch (error) {
                console.error('Error loading supported formats:', error);
                document.getElementById('image-formats').textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
                document.getElementById('video-formats').textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
                document.getElementById('max-size').textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
            }
        }

        function startTimer(type) {
            const timerElement = document.getElementById(type + '-timer');
            const startTime = Date.now();
            
            if (type === 'image') {
                imageStartTime = startTime;
                clearInterval(imageTimer);
                imageTimer = setInterval(() => updateTimer('image'), 100);
            } else {
                videoStartTime = startTime;
                clearInterval(videoTimer);
                videoTimer = setInterval(() => updateTimer('video'), 100);
            }
            
            timerElement.className = 'timer running';
        }

        function updateTimer(type) {
            const timerElement = document.getElementById(type + '-timer');
            const startTime = type === 'image' ? imageStartTime : videoStartTime;
            const elapsed = (Date.now() - startTime) / 1000;
            timerElement.textContent = `‚è±Ô∏è Th·ªùi gian x·ª≠ l√Ω: ${elapsed.toFixed(1)}s`;
        }

        function stopTimer(type) {
            const timerElement = document.getElementById(type + '-timer');
            if (type === 'image') {
                clearInterval(imageTimer);
            } else {
                clearInterval(videoTimer);
            }
            timerElement.className = 'timer';
        }

        function updateVideoModeUI() {
            const fastMode = document.getElementById('video-mode-fast').checked;
            const submitBtn = document.getElementById('video-submit-btn');
            const urlSubmitBtn = document.getElementById('video-url-submit-btn');
            const loadingText = document.getElementById('video-loading-text');
            
            if (fastMode) {
                submitBtn.textContent = '‚ö° Ki·ªÉm tra Video (Nhanh)';
                submitBtn.className = 'fast';
                urlSubmitBtn.textContent = '‚ö° Ki·ªÉm tra URL Video (Nhanh)';
                urlSubmitBtn.className = 'fast';
                loadingText.textContent = 'ƒêang ph√¢n t√≠ch video (ch·∫ø ƒë·ªô nhanh)...';
            } else {
                submitBtn.textContent = 'üîç Ki·ªÉm tra Video (Chu·∫©n)';
                submitBtn.className = '';
                urlSubmitBtn.textContent = 'üîç Ki·ªÉm tra URL Video (Chu·∫©n)';
                urlSubmitBtn.className = '';
                loadingText.textContent = 'ƒêang ph√¢n t√≠ch video (ch·∫ø ƒë·ªô chu·∫©n)...';
            }
        }

        // Update UI when mode changes
        document.querySelectorAll('input[name="video-mode"]').forEach(radio => {
            radio.addEventListener('change', updateVideoModeUI);
        });

        // Initialize UI
        updateVideoModeUI();

        // --- Form ph√¢n t√≠ch ·∫£nh (T·∫£i file) ---
        document.getElementById('image-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('image-file');
            if (!fileInput.files[0]) {
                alert('Vui l√≤ng ch·ªçn m·ªôt file ·∫£nh');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            handleRequest('/predict', formData, 'image-loading', 'image-result', {}, 'image');
        });

        // --- Form ph√¢n t√≠ch ·∫£nh (URL) ---
        document.getElementById('image-url-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('image-url').value;
            if (!url.trim()) {
                alert('Vui l√≤ng nh·∫≠p URL ·∫£nh');
                return;
            }
            const payload = JSON.stringify({ url: url });
            handleRequest('/predict', payload, 'image-loading', 'image-result', { 'Content-Type': 'application/json' }, 'image');
        });

        // --- Form ph√¢n t√≠ch video (T·∫£i file) ---
        document.getElementById('video-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('video-file');
            if (!fileInput.files[0]) {
                alert('Vui l√≤ng ch·ªçn m·ªôt file video');
                return;
            }
            
            const fastMode = document.getElementById('video-mode-fast').checked;
            const endpoint = fastMode ? '/predict_video_fast' : '/predict_video';
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            handleRequest(endpoint, formData, 'video-loading', 'video-result', {}, 'video');
        });

        // --- Form ph√¢n t√≠ch video (URL) ---
        document.getElementById('video-url-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('video-url').value;
            if (!url.trim()) {
                alert('Vui l√≤ng nh·∫≠p URL video');
                return;
            }
            
            const fastMode = document.getElementById('video-mode-fast').checked;
            const endpoint = fastMode ? '/predict_video_fast' : '/predict_video';
            
            const payload = JSON.stringify({ url: url });
            handleRequest(endpoint, payload, 'video-loading', 'video-result', { 'Content-Type': 'application/json' }, 'video');
        });

        async function handleRequest(endpoint, body, loaderId, resultId, headers = {}, timerType = null) {
            const loader = document.getElementById(loaderId);
            const resultDiv = document.getElementById(resultId);

            // Start loading and timer
            loader.classList.add('show');
            resultDiv.style.display = 'none';
            resultDiv.className = 'result'; // Reset class
            
            if (timerType) {
                startTimer(timerType);
            }

            // Disable submit buttons
            document.querySelectorAll('button[type="submit"]').forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: body
                });

                const data = await response.json();

                if (response.ok) {
                    // Create summary first
                    let summaryHtml = '';
                    if (data.result && data.result.nsfw_probability !== undefined) {
                        // Summary cho ·∫£nh
                        const isNsfw = data.result.is_nsfw;
                        const prob = (data.result.nsfw_probability * 100).toFixed(2);
                        summaryHtml = `<div class="result-summary ${isNsfw ? 'nsfw' : 'safe'}">
                            <h3>${isNsfw ? '‚ö†Ô∏è NSFW (Kh√¥ng ph√π h·ª£p)' : '‚úÖ An to√†n'}</h3>
                            <p><strong>X√°c su·∫•t NSFW:</strong> ${prob}%</p>
                            <p><strong>K√≠ch th∆∞·ªõc ·∫£nh:</strong> ${data.result.image_size ? data.result.image_size.join(' √ó ') + ' pixels' : 'N/A'}</p>
                            <p><strong>ƒê·ªãnh d·∫°ng:</strong> ${data.result.original_format || 'N/A'}</p>
                        </div>`;
                    } else if (data.result && data.result.max_nsfw_probability !== undefined) {
                        // Summary cho video
                        const isNsfw = data.result.is_nsfw;
                        const maxProb = (data.result.max_nsfw_probability * 100).toFixed(2);
                        const avgProb = (data.result.avg_nsfw_probability * 100).toFixed(2);
                        const processingTime = data.result.processing_time || 'N/A';
                        const mode = data.mode || (endpoint.includes('fast') ? 'fast' : 'standard');
                        
                        summaryHtml = `<div class="result-summary ${isNsfw ? 'nsfw' : 'safe'}">
                            <h3>${isNsfw ? '‚ö†Ô∏è NSFW (Kh√¥ng ph√π h·ª£p)' : '‚úÖ An to√†n'}</h3>
                            <p><strong>X√°c su·∫•t NSFW cao nh·∫•t:</strong> ${maxProb}%</p>
                            <p><strong>X√°c su·∫•t NSFW trung b√¨nh:</strong> ${avgProb}%</p>
                            <p><strong>Frames ph√¢n t√≠ch:</strong> ${data.result.total_frames}</p>
                            <p><strong>Frames NSFW:</strong> ${data.result.nsfw_frames_count}</p>
                            <p><strong>Th·ªùi gian x·ª≠ l√Ω:</strong> ${processingTime}s</p>
                            <p><strong>Ch·∫ø ƒë·ªô:</strong> ${mode === 'fast' ? '‚ö° Nhanh' : 'üîç Chu·∫©n'}</p>
                            <p><strong>K√≠ch th∆∞·ªõc file:</strong> ${data.result.file_size_mb || 'N/A'} MB</p>
                        </div>`;
                    }
                    
                    resultDiv.innerHTML = summaryHtml + '<div style="margin-top: 1em;"><strong>üìÑ D·ªØ li·ªáu chi ti·∫øt:</strong></div><pre style="background: #f8f9fa; padding: 1em; border-radius: 5px; overflow-x: auto; font-size: 0.9em;">' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<h3>‚ùå L·ªói ${response.status}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h3>‚ùå L·ªói m·∫°ng</h3><p>${error.message}</p>`;
            } finally {
                // Stop loading and timer
                loader.classList.remove('show');
                resultDiv.style.display = 'block';
                
                if (timerType) {
                    stopTimer(timerType);
                }

                // Re-enable submit buttons
                document.querySelectorAll('button[type="submit"]').forEach(btn => btn.disabled = false);
            }
        }
    </script>
</body>
</html>